<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>News Language Explorer</title>
    <style>
      :root {
        color-scheme: light;
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: #f5f6fb;
        color: #1f2a44;
      }

      body {
        margin: 0;
        padding: 32px 20px 64px;
        display: flex;
        justify-content: center;
      }

      .app {
        width: min(1100px, 100%);
      }

      header {
        display: flex;
        flex-direction: column;
        gap: 12px;
        margin-bottom: 28px;
      }

      h1 {
        font-size: clamp(2rem, 2.6vw, 2.6rem);
        margin: 0;
      }

      p.lead {
        margin: 0;
        font-size: 1.05rem;
        color: #4b5a7d;
      }

      form {
        display: grid;
        grid-template-columns: 1fr auto;
        gap: 12px;
        background: #ffffff;
        padding: 16px;
        border-radius: 16px;
        box-shadow: 0 18px 40px rgba(15, 23, 42, 0.08);
      }

      input[type="url"] {
        width: 100%;
        padding: 14px 16px;
        border-radius: 12px;
        border: 1px solid #d7dce8;
        font-size: 1rem;
      }

      button {
        background: #2f5cff;
        color: #fff;
        border: none;
        padding: 14px 26px;
        border-radius: 12px;
        font-size: 1rem;
        cursor: pointer;
        box-shadow: 0 12px 24px rgba(47, 92, 255, 0.25);
      }

      button:disabled {
        background: #9aa5d8;
        cursor: not-allowed;
        box-shadow: none;
      }

      .status {
        margin-top: 12px;
        font-size: 0.95rem;
        color: #51607f;
      }

      .content {
        margin-top: 28px;
        background: #ffffff;
        border-radius: 18px;
        padding: 22px;
        min-height: 200px;
        box-shadow: 0 16px 34px rgba(15, 23, 42, 0.06);
        line-height: 1.7;
      }

      .word {
        padding: 2px 4px;
        margin: 0 1px;
        border-radius: 6px;
        cursor: pointer;
        transition: background 0.2s ease, color 0.2s ease;
      }

      .word:hover {
        background: #e3e9ff;
        color: #1a3dd3;
      }

      .word.loading {
        background: #fff6d1;
      }

      .summary {
        display: flex;
        align-items: center;
        gap: 12px;
        margin-top: 12px;
        font-size: 0.9rem;
        color: #6b7a99;
      }

      .pill {
        background: #eff2ff;
        color: #2f5cff;
        padding: 4px 10px;
        border-radius: 999px;
        font-weight: 600;
      }

      dialog {
        width: min(520px, 92vw);
        border: none;
        border-radius: 16px;
        padding: 0;
        box-shadow: 0 20px 40px rgba(15, 23, 42, 0.25);
      }

      dialog::backdrop {
        background: rgba(15, 23, 42, 0.5);
      }

      .dialog-body {
        padding: 22px;
        display: grid;
        gap: 12px;
      }

      .dialog-body h2 {
        margin: 0;
      }

      .dialog-body p {
        margin: 0;
        color: #465373;
      }

      .dialog-actions {
        display: flex;
        justify-content: flex-end;
        padding: 0 22px 22px;
      }

      .note {
        font-size: 0.9rem;
        color: #7282a2;
      }

      @media (max-width: 720px) {
        form {
          grid-template-columns: 1fr;
        }

        button {
          width: 100%;
        }
      }
    </style>
  </head>
  <body>
    <div class="app">
      <header>
        <h1>News Language Explorer</h1>
        <p class="lead">
          Paste a news link, extract the story, and tap any word to see its
          meaning.
        </p>
      </header>

      <form id="news-form">
        <input
          id="news-url"
          type="url"
          placeholder="Paste a news URL (example: https://www.bbc.com/news...)"
          required
        />
        <button id="fetch-button" type="submit">Analyze Article</button>
      </form>
      <div class="status" id="status">Waiting for a link.</div>
      <div class="summary" id="summary" hidden>
        <span class="pill" id="word-count">0 words</span>
        <span id="definition-status">Definitions loadingâ€¦</span>
      </div>

      <section class="content" id="content">
        <p class="note">Your article text will appear here.</p>
      </section>
    </div>

    <dialog id="definition-dialog">
      <div class="dialog-body">
        <h2 id="dialog-word">Word</h2>
        <p id="dialog-definition">Definition</p>
        <p class="note" id="dialog-phonetic"></p>
        <p class="note" id="dialog-example"></p>
      </div>
      <div class="dialog-actions">
        <button id="close-dialog" type="button">Close</button>
      </div>
    </dialog>

    <script>
      const form = document.getElementById("news-form");
      const urlInput = document.getElementById("news-url");
      const statusEl = document.getElementById("status");
      const contentEl = document.getElementById("content");
      const summaryEl = document.getElementById("summary");
      const wordCountEl = document.getElementById("word-count");
      const definitionStatusEl = document.getElementById("definition-status");
      const dialog = document.getElementById("definition-dialog");
      const dialogWord = document.getElementById("dialog-word");
      const dialogDefinition = document.getElementById("dialog-definition");
      const dialogPhonetic = document.getElementById("dialog-phonetic");
      const dialogExample = document.getElementById("dialog-example");
      const closeDialogButton = document.getElementById("close-dialog");
      const fetchButton = document.getElementById("fetch-button");

      const definitionCache = new Map();
      const loadingWords = new Set();

      const buildProxyUrl = (url) => {
        const trimmed = url.trim();
        const safeUrl = trimmed.replace(/^https?:\/\//, "");
        return `https://r.jina.ai/http://${safeUrl}`;
      };

      const tokenize = (text) => {
        const tokens = [];
        const regex = /[A-Za-z']+|[^A-Za-z']+/g;
        let match;
        while ((match = regex.exec(text))) {
          tokens.push(match[0]);
        }
        return tokens;
      };

      const fetchDefinition = async (word) => {
        const normalized = word.toLowerCase();
        if (definitionCache.has(normalized)) {
          return definitionCache.get(normalized);
        }
        if (loadingWords.has(normalized)) {
          return null;
        }
        loadingWords.add(normalized);
        try {
          const response = await fetch(
            `https://api.dictionaryapi.dev/api/v2/entries/en/${encodeURIComponent(
              normalized
            )}`
          );
          if (!response.ok) {
            throw new Error("Definition not found");
          }
          const data = await response.json();
          const entry = data[0];
          const meaning = entry?.meanings?.[0]?.definitions?.[0];
          const definition = meaning?.definition ?? "No definition found.";
          const example = meaning?.example ?? "";
          const phonetic = entry?.phonetic ?? entry?.phonetics?.[0]?.text ?? "";
          const result = { definition, example, phonetic };
          definitionCache.set(normalized, result);
          return result;
        } catch (error) {
          const fallback = {
            definition: "No definition found in the Free Dictionary API.",
            example: "",
            phonetic: "",
          };
          definitionCache.set(normalized, fallback);
          return fallback;
        } finally {
          loadingWords.delete(normalized);
        }
      };

      const renderContent = (text) => {
        const tokens = tokenize(text);
        contentEl.innerHTML = "";
        const fragment = document.createDocumentFragment();

        tokens.forEach((token) => {
          if (/^[A-Za-z']+$/.test(token)) {
            const span = document.createElement("span");
            span.className = "word";
            span.dataset.word = token;
            span.textContent = token;
            fragment.appendChild(span);
          } else {
            fragment.appendChild(document.createTextNode(token));
          }
        });

        contentEl.appendChild(fragment);
      };

      const updateDefinitionStatus = (total, loaded) => {
        definitionStatusEl.textContent = `Loaded ${loaded} of ${total} word definitions.`;
      };

      const preloadDefinitions = async (uniqueWords) => {
        let loadedCount = 0;
        updateDefinitionStatus(uniqueWords.length, loadedCount);

        const concurrency = 5;
        let index = 0;

        const runNext = async () => {
          if (index >= uniqueWords.length) {
            return;
          }
          const word = uniqueWords[index++];
          await fetchDefinition(word);
          loadedCount += 1;
          updateDefinitionStatus(uniqueWords.length, loadedCount);
          await runNext();
        };

        const runners = Array.from({ length: concurrency }, runNext);
        await Promise.all(runners);
      };

      const openDefinitionDialog = async (word, target) => {
        dialogWord.textContent = word;
        dialogDefinition.textContent = "Loading definition...";
        dialogPhonetic.textContent = "";
        dialogExample.textContent = "";

        if (target) {
          target.classList.add("loading");
        }

        const definitionData = await fetchDefinition(word);
        dialogDefinition.textContent = definitionData.definition;
        dialogPhonetic.textContent = definitionData.phonetic
          ? `Phonetic: ${definitionData.phonetic}`
          : "";
        dialogExample.textContent = definitionData.example
          ? `Example: ${definitionData.example}`
          : "";

        if (target) {
          target.classList.remove("loading");
        }

        dialog.showModal();
      };

      form.addEventListener("submit", async (event) => {
        event.preventDefault();
        const url = urlInput.value.trim();
        if (!url) {
          return;
        }

        fetchButton.disabled = true;
        statusEl.textContent = "Fetching article content...";
        contentEl.innerHTML = "";
        summaryEl.hidden = true;
        definitionCache.clear();

        try {
          const response = await fetch(buildProxyUrl(url));
          if (!response.ok) {
            throw new Error("Unable to fetch the article.");
          }
          const text = await response.text();
          const cleaned = text.replace(/\n{2,}/g, "\n");
          const wordMatches = cleaned.match(/[A-Za-z']+/g) || [];
          const uniqueWords = Array.from(
            new Set(wordMatches.map((word) => word.toLowerCase()))
          );

          renderContent(cleaned);
          statusEl.textContent = "Article loaded. Click any word to learn more.";
          wordCountEl.textContent = `${wordMatches.length} words`;
          summaryEl.hidden = false;

          await preloadDefinitions(uniqueWords);
          definitionStatusEl.textContent = "All definitions loaded.";
        } catch (error) {
          statusEl.textContent =
            "Sorry, we could not load that article. Please try another link.";
          contentEl.innerHTML =
            "<p class=\"note\">We were unable to fetch the article text. This can happen if the site blocks access.</p>";
        } finally {
          fetchButton.disabled = false;
        }
      });

      contentEl.addEventListener("click", (event) => {
        const target = event.target;
        if (target instanceof HTMLElement && target.classList.contains("word")) {
          const word = target.dataset.word;
          if (word) {
            openDefinitionDialog(word, target);
          }
        }
      });

      closeDialogButton.addEventListener("click", () => {
        dialog.close();
      });

      dialog.addEventListener("click", (event) => {
        if (event.target === dialog) {
          dialog.close();
        }
      });
    </script>
  </body>
</html>
